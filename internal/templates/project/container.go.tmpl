package main

import (
	"context"
	"fmt"
	"os"

	"{{.GoModule}}/pkg/config"
	"{{.GoModule}}/pkg/logx"
	"github.com/jmoiron/sqlx"
	_ "github.com/lib/pq"
	"github.com/redis/go-redis/v9"
	// manifesto:container-imports
)

// Container holds shared infrastructure and composed module containers.
type Container struct {
	Config *config.Config

	// Infrastructure
	DB    *sqlx.DB
	Redis *redis.Client

	// Bounded-context containers
	// manifesto:container-fields
}

func NewContainer(cfg *config.Config) *Container {
	logx.Info("Initializing application container...")

	c := &Container{Config: cfg}

	c.initInfrastructure()
	c.initModules()

	logx.Info("Application container initialized")
	return c
}

// ---------------------------------------------------------------------------
// Infrastructure
// ---------------------------------------------------------------------------

func (c *Container) initInfrastructure() {
	logx.Info("Initializing infrastructure...")

	// Database
	dsn := fmt.Sprintf("host=%s port=%d user=%s password=%s dbname=%s sslmode=%s",
		c.Config.Database.Host,
		c.Config.Database.Port,
		c.Config.Database.User,
		c.Config.Database.Password,
		c.Config.Database.Name,
		c.Config.Database.SSLMode,
	)

	db, err := sqlx.Connect("postgres", dsn)
	if err != nil {
		logx.Fatalf("Failed to connect to database: %v", err)
	}
	db.SetMaxOpenConns(c.Config.Database.MaxOpenConns)
	db.SetMaxIdleConns(c.Config.Database.MaxIdleConns)
	db.SetConnMaxLifetime(c.Config.Database.ConnMaxLifetime)
	c.DB = db
	logx.Info("  Database connected")

	// Redis
	c.Redis = redis.NewClient(&redis.Options{
		Addr:     c.Config.Redis.Address(),
		Password: c.Config.Redis.Password,
		DB:       c.Config.Redis.DB,
	})
	if _, err := c.Redis.Ping(context.Background()).Result(); err != nil {
		logx.Fatalf("Failed to connect to Redis: %v (Redis is required)", err)
	}
	logx.Info("  Redis connected")

	logx.Info("Infrastructure initialized")
}

// ---------------------------------------------------------------------------
// Module composition
// ---------------------------------------------------------------------------

func (c *Container) initModules() {
	logx.Info("Initializing modules...")

	// manifesto:module-init
}

// ---------------------------------------------------------------------------
// Lifecycle
// ---------------------------------------------------------------------------

func (c *Container) StartBackgroundServices(ctx context.Context) {
	logx.Info("Starting background services...")
	// manifesto:background-start
}

func (c *Container) Cleanup() {
	logx.Info("Cleaning up resources...")

	if c.DB != nil {
		if err := c.DB.Close(); err != nil {
			logx.Errorf("Error closing database: %v", err)
		} else {
			logx.Info("  Database connection closed")
		}
	}

	if c.Redis != nil {
		if err := c.Redis.Close(); err != nil {
			logx.Errorf("Error closing Redis: %v", err)
		} else {
			logx.Info("  Redis connection closed")
		}
	}

	logx.Info("Cleanup complete")
}

func getEnv(key, fallback string) string {
	if value := os.Getenv(key); value != "" {
		return value
	}
	return fallback
}

// manifesto:container-helpers
